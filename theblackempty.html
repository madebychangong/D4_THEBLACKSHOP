<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‹¤ì‹œê°„ ê°€ê²©í‘œ í…ìŠ¤íŠ¸ ì…ë ¥</title>
  <style>
    body {
      font-family: Arial, Helvetica, 'Apple SD Gothic Neo', 'ë§‘ì€ ê³ ë”•', sans-serif;
      background-color: #121212;
      color: #fff;
      padding: 40px 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #1e1e1e;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255,255,255,0.1);
    }
    textarea {
      width: 100%;
      height: 240px;
      padding: 16px;
      font-size: 18px;
      background: #2a2a2a;
      color: #fff;
      border: none;
      border-radius: 6px;
      resize: vertical;
      line-height: 1.8;
      box-sizing: border-box;
      text-align: center;
      margin-bottom: 10px;
    }
    button {
      margin-top: 20px;
      background-color: #444;
      color: #fff;
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
    }
    button:disabled {
      background-color: #888;
      cursor: not-allowed;
    }
    #message {
      margin-top: 20px;
      color: #00ffd5;
      font-size: 16px;
      text-align: center;
    }
    #resultBox {
      display: none;
      margin-top: 40px;
      background: #232323;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #00ffd5;
      box-shadow: 0 2px 18px #00ffd540;
    }
    #resultBox h3 {
      color: #ffd700;
      font-size: 18px;
      margin: 0 0 8px 0;
      text-align: center;
    }
    #resultCode {
      width: 100%;
      height: 120px;
      font-size: 14px;
      padding: 14px;
      background: #121212;
      color: #00ffd5;
      border: 1px dashed #00ffd5;
      border-radius: 8px;
      resize: vertical;
      display: block;
      margin-top: 10px;
      margin-bottom: 5px;
      text-align: left;
      overflow: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    #copyBtn {
      display: block;
      margin: 0 auto 4px auto;
      padding: 6px 18px;
      background: #00ffd5;
      color: #232323;
      border: none;
      border-radius: 7px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    #copyBtn:active {
      background: #00c9aa;
    }
    iframe {
      position: absolute;
      left: -9999px;
      top: 0;
      width: 1px;
      height: 1px;
      border: none;
    }
    #imageHtmlPreviewSection {
      display: block !important;
      margin-top: 40px;
      text-align: center;
    }
    #imageHtmlPreviewSection h4 {
      color: #ffd700;
      font-size: 17px;
      margin-bottom: 10px;
      font-weight: 600;
    }
    #imagePreviewScrollBox {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background: #222;
      border-radius: 12px;
      width: 100%;
      max-width: 680px;
      height: 560px;
      overflow-y: auto;
      overflow-x: hidden;
      margin: 0 auto 8px auto;
      padding: 10px;
    }
    #imagePreview2 {
      display: block;
      width: 100%;
      max-width: 620px;
      height: auto;
      border-radius: 10px;
      background: #222;
      object-fit: contain;
    }
    #copyPreviewHtmlBtn {
      margin: 15px auto 7px auto;
      padding: 5px 18px;
      background: #ffd700;
      color: #232323;
      border: none;
      border-radius: 7px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
      display: inline-block;
    }
    #copyPreviewHtmlBtn:active {
      background: #c0a200;
    }
    #previewHtmlCode {
      width: 100%;
      max-width: 670px;
      height: 120px;
      font-size: 13px;
      padding: 8px;
      background: #191919;
      color: #ffd700;
      border: 1px dashed #ffd700;
      border-radius: 7px;
      resize: vertical;
      margin: 0 auto 8px auto;
      text-align: left;
      display: block;
      overflow: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
  <!-- supabase-js ë°˜ë“œì‹œ ë¨¼ì €! -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div class="container">
    <h2>ğŸ“ ì‹¤ì‹œê°„ ê°€ê²©í‘œ í…ìŠ¤íŠ¸ ì…ë ¥</h2>
    <form id="theblackForm">
      <textarea id="mainText" name="mainText" placeholder="ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      <button id="submitBtn" type="submit">âœ… í…ìŠ¤íŠ¸ ì ìš©í•˜ê¸°</button>
    </form>
    <div id="message"></div>
    <div id="resultBox">
      <h3>ğŸ‘‡ ì´ ì½”ë“œë¥¼ ë³µì‚¬í•˜ì„¸ìš” (ë³´í˜¸ ê¸°ëŠ¥ í¬í•¨)</h3>
      <textarea id="resultCode" readonly></textarea>
      <button id="copyBtn">ë³µì‚¬í•˜ê¸°</button>
    </div>
    <iframe id="hiddenFrame" src="" width="1" height="1"></iframe>
    <div id="imageHtmlPreviewSection">
      <h4>ğŸ“‹ ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€<br>ê°€ê²© ìˆ˜ì • ëëŠ”ì§€ í™•ì¸ í•„ìˆ˜!!!!</h4>
      <div id="imagePreviewScrollBox">
        <img id="imagePreview2" src="" alt="ë¯¸ë¦¬ë³´ê¸°" />
      </div>
      <br />
      <button id="copyPreviewHtmlBtn">ë‚˜ "ë³µì‚¬" ë²„íŠ¼</button>
      <textarea id="previewHtmlCode" readonly></textarea>
    </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const supabaseUrl = "https://ssnmitgehgzzcpmqwhzt.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzbm1pdGdlaGd6emNwbXF3aHp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNjI1MDgsImV4cCI6MjA2ODkzODUwOH0.u3FrSDh5qYeccQmn0PkOs4nfqIhXLSFHhpWj2JXhTrA";
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      // ê³ ì •ëœ ë¯¸ë¦¬ë³´ê¸° íŒŒì¼ëª…
      const previewFileName = "theblack04.png";

      // ë³´í˜¸ ê¸°ëŠ¥ì´ í¬í•¨ëœ HTML ì½”ë“œ ìƒì„± í•¨ìˆ˜ (JavaScript ìµœì†Œí™” ë²„ì „)
      function generateProtectedHtml(imageUrl) {
        return `<a href="https://open.kakao.com/o/gUVp9cwh" target="_blank" rel="noopener noreferrer" style="display:block; max-width:100%; margin:0 auto 20px auto; text-decoration:none;">
    <img src="${imageUrl}" 
         alt="ì˜¤í”ˆì¹´í†¡ ì—°ê²°" 
         style="cursor:pointer; max-width:100%; height:auto; border-radius:12px; display:block; margin:0 auto; -webkit-user-select:none; -moz-user-select:none; -ms-user-select:none; user-select:none; -webkit-user-drag:none; -khtml-user-drag:none; -moz-user-drag:none; -o-user-drag:none; user-drag:none; pointer-events:none;" 
         draggable="false"
         oncontextmenu="alert('ì´ë¯¸ì§€ ë³´í˜¸ ì¤‘ì…ë‹ˆë‹¤.'); return false;"
         ondragstart="return false;"
         onselectstart="return false;"
         onmousedown="if(event.button===2) return false;" />
</a>`;
      }

      // ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ í•­ìƒ ë³´ì—¬ì£¼ê¸° (ìºì‹œ ë¬´íš¨í™” ì¿¼ë¦¬ìŠ¤íŠ¸ë§ ì¶”ê°€)
      function setPreviewImage() {
        const publicUrl = supabase.storage.from("changong-images").getPublicUrl(previewFileName).data.publicUrl;
        const imagePreview = document.getElementById("imagePreview2");
        imagePreview.src = publicUrl + "?t=" + Date.now();
        
        // ë³´í˜¸ ê¸°ëŠ¥ì´ í¬í•¨ëœ HTML ì½”ë“œ ìƒì„±
        const resultCodeValue = generateProtectedHtml(publicUrl);
        document.getElementById("previewHtmlCode").value = resultCodeValue;
      }

      // í˜ì´ì§€ ì§„ì…ì‹œ í•­ìƒ ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
      setPreviewImage();

      // í¼ ì œì¶œ ì´ë²¤íŠ¸ ì²˜ë¦¬
      document.getElementById("theblackForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = document.getElementById("mainText").value.trim();
        const submitBtn = document.getElementById("submitBtn");
        const messageDiv = document.getElementById("message");
        if (!text) {
          messageDiv.innerText = "í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
          return;
        }
        submitBtn.disabled = true;
        messageDiv.innerText = "ì €ì¥ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.";

        try {
          // DBì— ì €ì¥ (user_id: "theblack04"ìœ¼ë¡œ ê³ ì •)
          const { error } = await supabase
            .from("user_texts")
            .upsert({ user_id: "theblack04", main_text: text }, { onConflict: "user_id" });

          if (error) throw error;

          messageDiv.innerText = "ì €ì¥ ì™„ë£Œ! ì´ë¯¸ì§€ ìƒì„± ì¤‘...";

          // ì´ë¯¸ì§€ ë Œë”ë§ì„ ìœ„í•´ theblackempty.html iframe í˜¸ì¶œ
          const params = new URLSearchParams({ uid: "theblack04" });
          document.getElementById("hiddenFrame").src = "theblackempty.html?" + params.toString();

          document.getElementById("hiddenFrame").onload = () => {
            setTimeout(() => {
              document.getElementById("hiddenFrame").contentWindow.postMessage({ type: "IFRAME_READY" }, "*");
            }, 1200);
          };
        } catch (err) {
          messageDiv.innerText = "ì €ì¥ ì‹¤íŒ¨: " + (err.message || err.error_description || JSON.stringify(err));
          submitBtn.disabled = false;
        }
      });

      // ì´ë¯¸ì§€ ìº¡ì²˜ ì™„ë£Œ ì´ë²¤íŠ¸ ì²˜ë¦¬
      window.addEventListener("message", async (event) => {
        if (event.data && event.data.type === "CAPTURE_DONE") {
          const dataUrl = event.data.dataUrl;
          const fileName = previewFileName; // "theblack04.png" ê³ ì •
          const fileData = await (await fetch(dataUrl)).blob();

          // ë””ë²„ê¹…: Blob ì‚¬ì´ì¦ˆ ë¡œê·¸
          console.log('ì—…ë¡œë“œ blob ì‚¬ì´ì¦ˆ:', fileData.size);

          // ê¸°ì¡´ íŒŒì¼ ì‚­ì œ(ì¶©ëŒ ë°©ì§€, upsert ì˜µì…˜ì—ë„ ì•ˆì „í•˜ê²Œ)
          await supabase.storage.from("changong-images").remove([fileName]);

          // ì´ë¯¸ì§€ Supabase ìŠ¤í† ë¦¬ì§€ì— ì—…ë¡œë“œ(í•­ìƒ theblack04.pngë¡œ upsert)
          const { error } = await supabase.storage
            .from("changong-images")
            .upload(fileName, fileData, {
              contentType: "image/png",
              cacheControl: "3600",
              upsert: true,
            });

          if (error) {
            console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:", error);
            document.getElementById("message").innerText = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: " + error.message;
            document.getElementById("submitBtn").disabled = false;
            return;
          }

          document.getElementById("message").innerText = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ!";
          document.getElementById("submitBtn").disabled = false;

          // ì—…ë¡œë“œ í›„ ë¯¸ë¦¬ë³´ê¸° ìƒˆë¡œê³ ì¹¨ (ìºì‹œ ë¬´íš¨í™”)
          setPreviewImage();
          
          // ê²°ê³¼ ë°•ìŠ¤ í‘œì‹œ ë° ë³´í˜¸ëœ HTML ì½”ë“œ ìƒì„±
          const publicUrl = supabase.storage.from("changong-images").getPublicUrl(fileName).data.publicUrl;
          const protectedHtml = generateProtectedHtml(publicUrl);
          
          document.getElementById("resultCode").value = protectedHtml;
          document.getElementById("resultBox").style.display = "block";
        }
      });

      // ë³µì‚¬ ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById("copyBtn").addEventListener("click", () => {
        document.getElementById("resultCode").select();
        document.execCommand("copy");
        alert("ë³´í˜¸ ê¸°ëŠ¥ì´ í¬í•¨ëœ HTML ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
      });

      // ë¯¸ë¦¬ë³´ê¸° HTML ë³µì‚¬ ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById("copyPreviewHtmlBtn").addEventListener("click", () => {
        document.getElementById("previewHtmlCode").select();
        document.execCommand("copy");
        alert("ë³´í˜¸ ê¸°ëŠ¥ì´ í¬í•¨ëœ ë¯¸ë¦¬ë³´ê¸° HTML ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
      });
    });
  </script>
</body>
</html>
