<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>THE BLACK í…œí”Œë¦¿</title>
  <style>
    @font-face {
      font-family: 'Pretendard';
      src: url('./fonts/Pretendard-Regular.woff2') format('woff2'),
           url('./fonts/Pretendard-Regular.woff') format('woff');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Pretendard';
      src: url('./fonts/Pretendard-Bold.woff2') format('woff2'),
           url('./fonts/Pretendard-Bold.woff') format('woff');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    html, body {
      margin: 0; padding: 0;
      background: linear-gradient(135deg, 
        #1a1a2e 0%, 
        #16213e 25%, 
        #0f3460 50%, 
        #533483 75%, 
        #1a1a2e 100%);
      color: #fff;
      font-family: 'Pretendard', Arial, sans-serif;
      box-sizing: border-box;
      min-height: 100vh;
    }
    .render-target {
      width: 600px;
      margin: 40px auto 0 auto;
      background: rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 40px 42px 36px 42px;
      text-align: center;
      position: relative;
      height: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -1px 0 rgba(255, 255, 255, 0.05);
    }
    .render-target::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.1) 0%, 
        rgba(255, 255, 255, 0.05) 25%, 
        rgba(255, 255, 255, 0.02) 50%, 
        rgba(255, 255, 255, 0.05) 75%, 
        rgba(255, 255, 255, 0.1) 100%);
      border-radius: 24px;
      pointer-events: none;
    }

    /* === ìº¡ì³ ì „ìš© ìŠ¤í‚¨ === */
    .render-target.capture-polish {
      border: none !important;
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.08),
        0 18px 40px rgba(0,0,0,0.55),
        0 6px 16px rgba(0,0,0,0.35) !important;
      background: #0f1117 !important;
      backdrop-filter: none !important;
    }
    .render-target.capture-polish::before {
      display: none !important;
    }
    .render-target.capture-polish .description {
      border: none !important;
      box-shadow: none !important;
      background: rgba(255,255,255,0.04) !important;
    }
    .render-target.capture-polish .divider,
    .render-target.capture-polish .subtitle-divider {
      border-top-color: transparent !important;
    }

    .shop-title {
      color: #ffe85c;
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 10px;
      margin-top: 0;
      letter-spacing: 2.5px;
      white-space: normal;
      text-align: center;
      line-height: 1.2;
      text-shadow: 
        0 0 10px rgba(255, 232, 92, 0.5),
        0 2px 4px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1;
    }
    .shop-title .icon {
      font-size: 40px;
      vertical-align: middle;
    }
    .shop-subtitle {
      color: rgba(255, 255, 255, 0.8);
      font-size: 20px;
      margin-bottom: 30px;
      font-weight: 400;
      letter-spacing: 0.8px;
      text-align: center;
      position: relative;
      z-index: 1;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    .divider, .subtitle-divider {
      border: none;
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      margin: 1px 0 1px 0;
      position: relative;
      z-index: 1;
    }
    .info-list {
      margin: 0 0 0px 0;
      padding: 0;
      list-style: none;
      font-size: 22px;
      font-weight: 400;
      text-align: center;
      position: relative;
      z-index: 1;
    }
    .info-list li {
      display: block !important;
      white-space: normal !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      margin: 6px 0;
      line-height: 1.65;
      color: rgba(255, 255, 255, 0.9);
      letter-spacing: 0.3px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    .info-list li .icon {
      font-size: 21px;
      margin-right: 10px;
      vertical-align: middle;
    }
    .cta-btn {
      margin: 18px auto 22px auto;
      background: linear-gradient(135deg, #1affeb 0%, #0ee5d0 100%);
      color: #0a0a0a;
      font-weight: 900;
      font-size: 23px;
      padding: 14px 40px 14px 40px;
      border-radius: 22px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: inline-block;
      box-shadow: 
        0 4px 16px rgba(26, 255, 235, 0.3),
        0 2px 4px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      cursor: default;
      pointer-events: none;
      text-decoration: none;
      text-align: center;
      font-family: 'Pretendard', Arial, sans-serif;
      letter-spacing: 0.5px;
      position: relative;
      z-index: 1;
    }
    .section-price-title {
      font-size: 32px;
      color: #3dffb8;
      font-weight: 900;
      margin-bottom: 20px;
      margin-top: 0;
      letter-spacing: 1.2px;
      text-align: center;
      font-family: 'Pretendard', Arial, sans-serif;
      text-shadow: 
        0 0 10px rgba(61, 255, 184, 0.4),
        0 2px 4px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1;
    }
    .description {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.85);
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      font-weight: 500;
      white-space: pre-wrap;
      margin: 0;
      min-height: 60px;
      line-height: 1.75;
      letter-spacing: 0.6px;
      font-family: 'Pretendard', Arial, sans-serif;
      position: relative;
      z-index: 1;
      backdrop-filter: blur(10px);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    /* === ê°€ê²©í‘œ ì»¨í…Œì´ë„ˆ === */
    #priceContainer {
      position: relative;
    }
  </style>
  <!-- ìˆœì„œ ë§¤ìš° ì¤‘ìš”!! -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>

  <div class="render-target" id="capture">
    <div>
      <h1 class="shop-title">
        <span class="icon">ğŸ¦‡</span> THE BLACK SHOP <span class="icon">ğŸ§›â€â™‚ï¸</span>
      </h1>
      <div class="shop-subtitle">ë””ì•„ë¸”ë¡œ4 ì‹œì¦Œ10 ë²„ìŠ¤ Â· ëŒ€ë¦¬ Â· ì•„ì´í…œ ì „ë¬¸ ê±°ë˜ì†Œ</div>
      <hr class="subtitle-divider" />
    </div>

    <ul class="info-list">
      <li><span class="icon">ğŸ¦¾</span>ëª¨ë“  ì¥ë¹„, ì•„ì´í…œ, ì¬ë£Œ ì™„ë¹„</li>
      <li><span class="icon">ğŸšŒ</span>ë²„ìŠ¤, ëŒ€ë¦¬, ì„¸íŒ… í’€ ì§€ì›</li>
      <li><span class="icon">ğŸ¦¸â€â™‚ï¸</span>ê²½í—˜ ë§ì€ ì „ë¬¸ ê¸°ì‚¬ ìƒì‹œ ëŒ€ê¸°</li>
      <li><span class="icon">ğŸ”¥</span>í•©ë¦¬ì ì¸ ì‹¤ì‹œê°„ ìµœì €ê°€ ë³´ì¥</li>
    </ul>
    <div class="cta-btn">
      ğŸ’¬ ì˜¤í”ˆì±„íŒ…ì€ ê°€ê²©í‘œ í´ë¦­!
    </div>
    <hr class="divider" />
    <div>
      <h2 class="section-price-title">ğŸ’° ì‹¤ì‹œê°„ ê°€ê²©í‘œ</h2>
    </div>

    <!-- ê°€ê²©í‘œ ì˜ì—­ (ê²½ê³  ë°°ë„ˆ ì œê±° ë²„ì „) -->
    <div id="priceContainer"></div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // íŒŒë¼ë¯¸í„° ì½ê¸°
      const params = new URLSearchParams(window.location.search);
      const userId = params.get("uid");
      const mainTextParam = params.get("mainText");
      let mainTextLoaded = false;

      // ğŸ”¹ (ì¶”ê°€) ë‹¨ì¼ ë§í¬ íŒŒë¼ë¯¸í„°: ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
      const chatUrl = params.get("chat") || "https://open.kakao.com/o/somechat";
      // === THE BLACK íƒœê·¸ ìŠ¤íƒ€ì¼ ì„¤ì • (ìƒ‰ìƒ/ìê°„/ì¤„ê°„ê²© ë³€ê²½ì€ ì—¬ê¸°ì„œ) ===
      const TB_TAG = {
        colorMode: 'random', // 'random' | 'fixed'
        fixedColor: '#00FFD5',
        palette: ['#00FFD5', '#FFD166', '#FF6B6B', '#7C5CFF', '#7CF17F', '#56C0FF', '#FF9F43', '#F72585', '#4CC9F0', '#B9FBC0'],
        letterSpacing: '0.0px',   // ìê°„
        lineHeight: '1.35',       // ì¤„ê°„ê²©
        fontWeight: 800
      };



// === êµ¬ë¶„ì„  ëŒ€ì²´ ì‚½ì… + ìƒ‰ìƒ/ìê°„ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ + ì•ˆì „ HTML ===
function insertChatLinks(text, chatUrl) {
  const escapeHTML = (s) => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const pickColor = (i) => TB_TAG.colorMode === 'fixed' ? TB_TAG.fixedColor : TB_TAG.palette[i % TB_TAG.palette.length];

  // 1) ì‹¤ì œ êµ¬ë¶„ì„  í† í°í™” (---, ***, ===, ___, â”€â”€â”€, â”â”â”, â€”â€”â€”, ï¼ï¼ï¼, ï¼¿ï¼¿ï¼¿, ã…¡ã…¡ã…¡ ë“±)
  const dividerClass = "[\-\*=~_â”€â”â€”â€“ï¼ï¼¿ã…¡]";
  const splitRe = new RegExp(`(${dividerClass}{3,})`, 'g');
  const tokens = text.split(splitRe); // [seg0, div1, seg1, div2, seg2, ...]
  const dividerIdxs = [];
  for (let i = 1; i < tokens.length; i += 2) dividerIdxs.push(i);

  // 2) êµì²´í•  êµ¬ë¶„ì„  3ê³³ ì„ íƒ (1/4, 1/2, 3/4 ì§€ì  ê·¼ì²˜)
  let chosen = [];
  if (dividerIdxs.length > 0) {
    const candidates = [
      Math.floor(dividerIdxs.length / 4),
      Math.floor(dividerIdxs.length / 2),
      Math.floor(3 * dividerIdxs.length / 4)
    ];
    const seen = new Set();
    chosen = candidates
      .map(ix => dividerIdxs[Math.max(0, Math.min(dividerIdxs.length - 1, ix))])
      .filter(i => Number.isInteger(i) && !seen.has(i) && (seen.add(i), true));
  }

  // 3) êµ¬ë¶„ì„ ì´ 0~2ê°œë¿ì´ë©´: ê°€ëŠ¥í•œ ë§Œí¼ë§Œ ëŒ€ì²´í•˜ê³ , ë¶€ì¡±ë¶„ì€ ë©ì–´ë¦¬ ì‚¬ì´ì— ì¶”ê°€
  let extraNeeded = Math.max(0, 3 - chosen.length);

  // 4) íƒœê·¸ HTML ìƒì„±ê¸° (ìƒ‰ìƒ/ìê°„/ì¤„ê°„ê²© ë°˜ì˜)
  let tagCount = 0;
  const makeTag = () => {
    const color = pickColor(tagCount++);
    const leftText = '#ë””ì•„ë¸”ë¡œ4 THEBLACK ì˜¤í”ˆì±„íŒ…ë§í¬í™•ì¸ â†’ ';
    return `<div class="tb-tagline" style="
      margin:6px 0;
      font-weight:${TB_TAG.fontWeight};
      letter-spacing:${TB_TAG.letterSpacing};
      line-height:${TB_TAG.lineHeight};
      color:${color};
      text-shadow:0 0 6px rgba(0,0,0,.35);
    ">${escapeHTML(leftText)}<span style="color:${color}; text-decoration:underline;">${escapeHTML(chatUrl)}</span></div>`;
  };

  // 5) HTMLë¡œ ì¬ì¡°ë¦½
  let html = '';
  for (let i = 0; i < tokens.length; i++) {
    const isDivider = (i % 2 === 1);
    if (!isDivider) {
      html += escapeHTML(tokens[i]); // ë³¸ë¬¸ì€ ì „ë¶€ escape
      continue;
    }
    if (chosen.includes(i)) {
      // ì„ íƒëœ êµ¬ë¶„ì„ ì€ íƒœê·¸ë¡œ ëŒ€ì²´
      html += `
${makeTag()}
`;
    } else {
      // ê·¸ ì™¸ êµ¬ë¶„ì„ ì€ ë³´ê¸° ì¢‹ê²Œ ìœ ì§€
      html += `
${escapeHTML(tokens[i])}
`;
    }
  }

  // 6) êµ¬ë¶„ì„  ìì²´ê°€ ê±°ì˜ ì—†ì„ ë•Œ ë¶€ì¡±ë¶„ ì¶”ê°€
  while (extraNeeded-- > 0) {
    html += `
-----------------------------------------
${makeTag()}
`;
  }

  return html;
}
\n`;

  // 1) ì–´ë–¤ 'ëŒ€ì‹œë¥˜' êµ¬ë¶„ì„ ì´ ì™€ë„ ìë¥´ëŠ” ë²”ìš© íŒ¨í„´ (3ê°œ ì´ìƒ ì—°ì†)
  //    í¬í•¨ ë¬¸ì: -, *, =, ~, _, â”€, â”, â€”, â€“ , ï¼(ì „ê°), ï¼¿(ì „ê°), ã…¡(í•œê¸€ ê¸°í˜¸)
  const dividerClass = "[\\-\\*=~_â”€â”â€”â€“ï¼ï¼¿ã…¡]";
  const anyDividerRE = new RegExp(`\\s*${dividerClass}{3,}\\s*`, "g");

  // 2) êµ¬ë¶„ì„ ìœ¼ë¡œ 1ì°¨ ë¶„í•  (ê¸¸ì´ê°€ ì œê°ê°ì´ì–´ë„ OK)
  let parts = text.split(anyDividerRE);

  // 3) êµ¬ë¶„ì„ ì´ ì „í˜€ ì—†ì„ ë•ŒëŠ” ì¤„ ê¸°ì¤€ìœ¼ë¡œ ëŒ€ì²´ ë¶„í• 
  if (parts.length < 2) {
    const lines = text.split(/\r?\n/);
    // ì¤„ ìˆ˜ê°€ ì ìœ¼ë©´ ê·¸ëƒ¥ ì›ë¬¸ í•œ ë©ì–´ë¦¬ ì·¨ê¸‰
    if (lines.length < 6) {
      // ìµœì†Œ ë³´ì¥: ë³¸ë¬¸ ë’¤ì— 3íšŒ ì‚½ì…
      return text + `\n\n${tagLine}\n${tagLine}\n${tagLine}`;
    }
    // ì¤„ì„ 3~4ë“±ë¶„ ì§€ì ì—ì„œ ë¶„í• 
    const p1 = Math.floor(lines.length / 4);
    const p2 = Math.floor(lines.length / 2);
    const p3 = Math.floor((3 * lines.length) / 4);
    const chunks = [
      lines.slice(0, p1).join("\n"),
      lines.slice(p1, p2).join("\n"),
      lines.slice(p2, p3).join("\n"),
      lines.slice(p3).join("\n"),
    ];
    parts = chunks;
  }

  // 4) ì‚½ì… ìœ„ì¹˜ ê³„ì‚° (ê°€ëŠ¥í•˜ë©´ 1/4, 1/2, 3/4 ì§€ì )
  let positions = [];
  if (parts.length >= 4) {
    positions = [
      Math.floor(parts.length / 4),
      Math.floor(parts.length / 2),
      Math.floor((3 * parts.length) / 4),
    ];
    // ìœ íš¨/ì¤‘ë³µ ì œê±°
    const seen = new Set();
    positions = positions.filter(
      (i) => i > 0 && i < parts.length && !seen.has(i) && (seen.add(i), true)
    );
  } else {
    // ë©ì–´ë¦¬ê°€ ì ì„ ë•Œ: ê°€ëŠ¥í•œ ë²”ìœ„ì—ì„œ ìµœëŒ€ 3íšŒ
    const step = Math.max(1, Math.floor(parts.length / 3));
    for (let i = step; i < parts.length && positions.length < 3; i += step) {
      if (i > 0 && i < parts.length) positions.push(i);
    }
  }

  // 5) ì¬í•©ì„± (êµ¬ë¶„ì„ ì€ ë³´ê¸° ì¢‹ê²Œ ê¸´ í•˜ì´í”ˆìœ¼ë¡œ í†µì¼)
  const rebuiltDivider = "\n-----------------------------------------\n";
  positions.sort((a, b) => a - b);
  for (let k = positions.length - 1; k >= 0; k--) {
    const idx = positions[k];
    parts[idx] = parts[idx].trim() + rebuiltDivider + tagLine;
  }
  return parts.join(rebuiltDivider);
}

      // ê°€ê²©í‘œ ë Œë”(ê²½ê³ /ë¦¬ë³¸ ì—†ì´ ë‹¨ì¼ ë°•ìŠ¤)
      function renderPrice(text) {
        const container = document.getElementById('priceContainer');
        container.innerHTML = '';
        const descDiv = document.createElement('div');
        descDiv.className = 'description';
        // (ë³€ê²½) í…ìŠ¤íŠ¸ì— ë§í¬ 3ê³³ ìë™ ì‚½ì…
        descDiv.innerHTML = insertChatLinks(text || '', chatUrl);
        container.appendChild(descDiv);
      }

      // mainText íŒŒë¼ë¯¸í„° ìˆìœ¼ë©´ ë°”ë¡œ ì ìš©
      if (mainTextParam) {
        const decodedText = decodeURIComponent(mainTextParam);
        renderPrice(decodedText);
        mainTextLoaded = true;
      } else if (userId) {
        // Supabase ì´ˆê¸°í™”
        const supabaseUrl = 'https://ssnmitgehgzzcpmqwhzt.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzbm1pdGdlaGd6emNwbXF3aHp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNjI1MDgsImV4cCI6MjA2ODkzODUwOH0.u3FrSDh5qYeccQmn0PkOs4nfqIhXLSFHhpWj2JXhTrA';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        (async function loadText() {
          const { data, error } = await supabase
            .from('user_texts')
            .select('main_text')
            .eq('user_id', userId)
            .order('created_at', { ascending: false })
            .limit(1);

          if (!error && data && data.length > 0) {
            renderPrice(data[0].main_text);
          } else {
            renderPrice('');
          }
          mainTextLoaded = true;
        })();
      } else {
        renderPrice('');
        mainTextLoaded = true;
      }

      // IFRAME ë©”ì‹œì§€(ìº¡ì²˜ ìš”ì²­) í•¸ë“¤ëŸ¬
      window.addEventListener('message', async (event) => {
        if (event.data?.type === 'IFRAME_READY') {
          // mainText ì ìš© ì™„ë£Œê¹Œì§€ ìµœëŒ€ 2ì´ˆ ëŒ€ê¸°
          let waitCount = 0;
          while (!mainTextLoaded && waitCount < 100) {
            await new Promise(res => setTimeout(res, 20));
            waitCount++;
          }
          if (document.fonts && document.fonts.ready) {
            await document.fonts.ready;
          }
          captureAndSend();
        }
      });

      function captureAndSend() {
        const target = document.querySelector('.render-target');
        if (!target) {
          console.error('.render-target ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ìº¡ì³ìš© ìŠ¤í‚¨ ì ìš©
        target.classList.add('capture-polish');

        // ìŠ¤íƒ€ì¼ í˜ì¸íŠ¸ ì™„ë£Œ ì´í›„ ìº¡ì³
        requestAnimationFrame(() => {
          html2canvas(target, {
            useCORS: true,
            allowTaint: true,
            backgroundColor: null,
            scale: Math.max(2, window.devicePixelRatio),
            logging: false,
            removeContainer: true
          }).then((canvas) => {
            // ìƒˆ ìº”ë²„ìŠ¤ ìƒì„±í•˜ê³  ë°°ê²½ìƒ‰ ë¨¼ì € ê·¸ë¦¬ê¸°
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = canvas.width;
            finalCanvas.height = canvas.height;
            const ctx = finalCanvas.getContext('2d');
            
            // ë°°ê²½ìƒ‰ ì±„ìš°ê¸°
            ctx.fillStyle = '#0f1117';
            ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
            
            // ì›ë³¸ ì´ë¯¸ì§€ ìœ„ì— ê·¸ë¦¬ê¸°
            ctx.drawImage(canvas, 0, 0);
            
            const imgData = finalCanvas.toDataURL('image/png');
            parent.postMessage({ type: 'CAPTURE_DONE', dataUrl: imgData }, '*');
          }).finally(() => {
            target.classList.remove('capture-polish');
          });
        });
      }
    });
  </script>

</body>
</html>
