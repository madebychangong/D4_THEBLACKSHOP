<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>THE BLACK í…œí”Œë¦¿</title>
  <style>
    @font-face {
      font-family: 'Pretendard';
      src: url('./fonts/Pretendard-Regular.woff2') format('woff2'),
           url('./fonts/Pretendard-Regular.woff') format('woff');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Pretendard';
      src: url('./fonts/Pretendard-Bold.woff2') format('woff2'),
           url('./fonts/Pretendard-Bold.woff') format('woff');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    html, body {
      margin: 0; padding: 0;
      background: linear-gradient(135deg, 
        #1a1a2e 0%, 
        #16213e 25%, 
        #0f3460 50%, 
        #533483 75%, 
        #1a1a2e 100%);
      color: #fff;
      font-family: 'Pretendard', Arial, sans-serif;
      box-sizing: border-box;
      min-height: 100vh;
    }
    .render-target {
      width: 600px;
      margin: 40px auto 0 auto;
      background: rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 40px 42px 36px 42px;
      text-align: center;
      position: relative;
      height: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -1px 0 rgba(255, 255, 255, 0.05);
    }
    .render-target::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.1) 0%, 
        rgba(255, 255, 255, 0.05) 25%, 
        rgba(255, 255, 255, 0.02) 50%, 
        rgba(255, 255, 255, 0.05) 75%, 
        rgba(255, 255, 255, 0.1) 100%);
      border-radius: 24px;
      pointer-events: none;
    }

    .render-target.capture-polish {
      border: none !important;
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.08),
        0 18px 40px rgba(0,0,0,0.55),
        0 6px 16px rgba(0,0,0,0.35) !important;
      background: #0f1117 !important;
      backdrop-filter: none !important;
    }
    .render-target.capture-polish::before {
      display: none !important;
    }
    .render-target.capture-polish .description {
      border: none !important;
      box-shadow: none !important;
      background: rgba(255,255,255,0.04) !important;
    }
    .render-target.capture-polish .divider,
    .render-target.capture-polish .subtitle-divider {
      border-top-color: transparent !important;
    }

    .shop-title {
      color: #ffe85c;
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 10px;
      margin-top: 0;
      letter-spacing: 2.5px;
      text-align: center;
      line-height: 1.2;
      text-shadow: 
        0 0 10px rgba(255, 232, 92, 0.5),
        0 2px 4px rgba(0, 0, 0, 0.3);
    }
    .shop-subtitle {
      color: rgba(255, 255, 255, 0.8);
      font-size: 20px;
      margin-bottom: 30px;
      font-weight: 400;
      letter-spacing: 0.8px;
      text-align: center;
    }
    .divider, .subtitle-divider {
      border: none;
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      margin: 1px 0 1px 0;
    }
    .info-list {
      list-style: none;
      font-size: 22px;
      text-align: center;
      padding: 0;
      margin: 0;
    }
    .info-list li {
      margin: 6px 0;
      line-height: 1.65;
      color: rgba(255, 255, 255, 0.9);
    }
    .cta-btn {
      margin: 18px auto 22px auto;
      background: linear-gradient(135deg, #1affeb 0%, #0ee5d0 100%);
      color: #0a0a0a;
      font-weight: 900;
      font-size: 23px;
      padding: 14px 40px;
      border-radius: 22px;
      display: inline-block;
      box-shadow: 
        0 4px 16px rgba(26, 255, 235, 0.3),
        0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .section-price-title {
      font-size: 32px;
      color: #3dffb8;
      font-weight: 900;
      margin-bottom: 20px;
      text-align: center;
      text-shadow: 0 0 10px rgba(61, 255, 184, 0.4);
    }
    .description {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.85);
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      font-weight: 500;
      white-space: pre-wrap;
      line-height: 1.75;
      letter-spacing: 0.6px;
      backdrop-filter: blur(10px);
    }

    #priceContainer {
      position: relative;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>

  <div class="render-target" id="capture">
    <h1 class="shop-title">ğŸ¦‡ THE BLACK SHOP ğŸ§›â€â™‚ï¸</h1>
    <div class="shop-subtitle">ë””ì•„ë¸”ë¡œ4 ì‹œì¦Œ10 ë²„ìŠ¤ Â· ëŒ€ë¦¬ Â· ì•„ì´í…œ ì „ë¬¸ ê±°ë˜ì†Œ</div>
    <hr class="subtitle-divider" />

    <ul class="info-list">
      <li>ğŸ¦¾ ëª¨ë“  ì¥ë¹„, ì•„ì´í…œ, ì¬ë£Œ ì™„ë¹„</li>
      <li>ğŸšŒ ë²„ìŠ¤, ëŒ€ë¦¬, ì„¸íŒ… í’€ ì§€ì›</li>
      <li>ğŸ¦¸â€â™‚ï¸ ê²½í—˜ ë§ì€ ì „ë¬¸ ê¸°ì‚¬ ìƒì‹œ ëŒ€ê¸°</li>
      <li>ğŸ”¥ í•©ë¦¬ì ì¸ ì‹¤ì‹œê°„ ìµœì €ê°€ ë³´ì¥</li>
    </ul>

    <div class="cta-btn">ğŸ’¬ ì˜¤í”ˆì±„íŒ…ì€ ê°€ê²©í‘œ í´ë¦­!</div>

    <hr class="divider" />
    <h2 class="section-price-title">ğŸ’° ì‹¤ì‹œê°„ ê°€ê²©í‘œ</h2>
    <div id="priceContainer"></div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const userId = params.get("uid");
      const mainTextParam = params.get("mainText");
      let mainTextLoaded = false;

      // ğŸ”¹ ìë™ êµ¬ë¶„ì„  ê°ì§€ + ë§í¬ ì‚½ì… í•¨ìˆ˜
      function insertChatLinks(text) {
        const chatText = "\n#ë””ì•„ë¸”ë¡œ4 THEBLACK ì˜¤í”ˆì±„íŒ…ë§í¬í™•ì¸ â†’ https://open.kakao.com/o/somechat\n";
        const dividerRegex = /([\\-*=_~]{3,})/g;
        const matches = [...text.matchAll(dividerRegex)].map(m => m[1]);

        let divider = "-----------------------------------------";
        if (matches.length > 0) {
          const freq = {};
          for (const m of matches) freq[m] = (freq[m] || 0) + 1;
          divider = Object.entries(freq).sort((a,b) => b[1]-a[1])[0][0];
        }

        const parts = text.split(new RegExp(divider.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'), 'g'));
        const step = Math.max(1, Math.floor(parts.length / 3));

        for (let i = step; i < parts.length; i += step) {
          parts[i] = parts[i].trim() + "\n" + divider + "\n" + chatText;
        }

        return parts.join("\n" + divider + "\n");
      }

      function renderPrice(text) {
        const container = document.getElementById('priceContainer');
        container.innerHTML = '';
        const descDiv = document.createElement('div');
        descDiv.className = 'description';
        descDiv.innerText = insertChatLinks(text || '');
        container.appendChild(descDiv);
      }

      if (mainTextParam) {
        const decoded = decodeURIComponent(mainTextParam);
        renderPrice(decoded);
        mainTextLoaded = true;
      } else if (userId) {
        const supabase = window.supabase.createClient(
          'https://ssnmitgehgzzcpmqwhzt.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzbm1pdGdlaGd6emNwbXF3aHp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNjI1MDgsImV4cCI6MjA2ODkzODUwOH0.u3FrSDh5qYeccQmn0PkOs4nfqIhXLSFHhpWj2JXhTrA'
        );
        (async function loadText() {
          const { data } = await supabase
            .from('user_texts')
            .select('main_text')
            .eq('user_id', userId)
            .order('created_at', { ascending: false })
            .limit(1);
          if (data && data.length > 0) renderPrice(data[0].main_text);
          else renderPrice('');
          mainTextLoaded = true;
        })();
      } else {
        renderPrice('');
        mainTextLoaded = true;
      }

      window.addEventListener('message', async (event) => {
        if (event.data?.type === 'IFRAME_READY') {
          let wait = 0;
          while (!mainTextLoaded && wait < 100) {
            await new Promise(r => setTimeout(r, 20));
            wait++;
          }
          if (document.fonts && document.fonts.ready) await document.fonts.ready;
          captureAndSend();
        }
      });

      function captureAndSend() {
        const target = document.querySelector('.render-target');
        if (!target) return;
        target.classList.add('capture-polish');
        requestAnimationFrame(() => {
          html2canvas(target, {
            useCORS: true,
            allowTaint: true,
            backgroundColor: null,
            scale: Math.max(2, window.devicePixelRatio),
          }).then((canvas) => {
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = canvas.width;
            finalCanvas.height = canvas.height;
            const ctx = finalCanvas.getContext('2d');
            ctx.fillStyle = '#0f1117';
            ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
            ctx.drawImage(canvas, 0, 0);
            const imgData = finalCanvas.toDataURL('image/png');
            parent.postMessage({ type: 'CAPTURE_DONE', dataUrl: imgData }, '*');
          }).finally(() => target.classList.remove('capture-polish'));
        });
      }
    });
  </script>
</body>
</html>
