<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>THE BLACK 템플릿</title>
  <style>
    @font-face {
      font-family: 'Pretendard';
      src: url('./fonts/Pretendard-Regular.woff2') format('woff2'),
           url('./fonts/Pretendard-Regular.woff') format('woff');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Pretendard';
      src: url('./fonts/Pretendard-Bold.woff2') format('woff2'),
           url('./fonts/Pretendard-Bold.woff') format('woff');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    html, body {
      margin: 0; padding: 0;
      background: linear-gradient(135deg, 
        #1a1a2e 0%, 
        #16213e 25%, 
        #0f3460 50%, 
        #533483 75%, 
        #1a1a2e 100%);
      color: #fff;
      font-family: 'Pretendard', Arial, sans-serif;
      box-sizing: border-box;
      min-height: 100vh;
    }
    .render-target {
      width: 600px;
      margin: 40px auto 0 auto;
      background: rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 40px 42px 36px 42px;
      text-align: center;
      position: relative;
      height: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -1px 0 rgba(255, 255, 255, 0.05);
    }
    .render-target::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.1) 0%, 
        rgba(255, 255, 255, 0.05) 25%, 
        rgba(255, 255, 255, 0.02) 50%, 
        rgba(255, 255, 255, 0.05) 75%, 
        rgba(255, 255, 255, 0.1) 100%);
      border-radius: 24px;
      pointer-events: none;
    }

    /* === 캡쳐 전용 스킨 === */
    .render-target.capture-polish {
      border: none !important;
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.08),
        0 18px 40px rgba(0,0,0,0.55),
        0 6px 16px rgba(0,0,0,0.35) !important;
      background-color: #0f1117 !important;
      background-image: linear-gradient(180deg,
          rgba(255,255,255,0.06) 0%,
          rgba(255,255,255,0.02) 100%);
    }
    .render-target.capture-polish::before {
      display: none !important;
    }
    .render-target.capture-polish .description {
      border: none !important;
      box-shadow: none !important;
      background: rgba(255,255,255,0.04) !important;
    }
    .render-target.capture-polish .divider,
    .render-target.capture-polish .subtitle-divider {
      border-top-color: transparent !important;
    }

    .shop-title {
      color: #ffe85c;
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 10px;
      margin-top: 0;
      letter-spacing: 2.5px;
      white-space: normal;
      text-align: center;
      line-height: 1.2;
      text-shadow: 
        0 0 10px rgba(255, 232, 92, 0.5),
        0 2px 4px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1;
    }
    .shop-title .icon {
      font-size: 40px;
      vertical-align: middle;
    }
    .shop-subtitle {
      color: rgba(255, 255, 255, 0.8);
      font-size: 20px;
      margin-bottom: 30px;
      font-weight: 400;
      letter-spacing: 0.8px;
      text-align: center;
      position: relative;
      z-index: 1;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    .divider, .subtitle-divider {
      border: none;
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      margin: 1px 0 1px 0;
      position: relative;
      z-index: 1;
    }
    .info-list {
      margin: 0 0 0px 0;
      padding: 0;
      list-style: none;
      font-size: 22px;
      font-weight: 400;
      text-align: center;
      position: relative;
      z-index: 1;
    }
    .info-list li {
      display: block !important;
      white-space: normal !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      margin: 6px 0;
      line-height: 1.65;
      color: rgba(255, 255, 255, 0.9);
      letter-spacing: 0.3px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    .info-list li .icon {
      font-size: 21px;
      margin-right: 10px;
      vertical-align: middle;
    }
    .cta-btn {
      margin: 18px auto 22px auto;
      background: linear-gradient(135deg, #1affeb 0%, #0ee5d0 100%);
      color: #0a0a0a;
      font-weight: 900;
      font-size: 23px;
      padding: 14px 40px 14px 40px;
      border-radius: 22px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: inline-block;
      box-shadow: 
        0 4px 16px rgba(26, 255, 235, 0.3),
        0 2px 4px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      cursor: default;
      pointer-events: none;
      text-decoration: none;
      text-align: center;
      font-family: 'Pretendard', Arial, sans-serif;
      letter-spacing: 0.5px;
      position: relative;
      z-index: 1;
    }
    .section-price-title {
      font-size: 32px;
      color: #3dffb8;
      font-weight: 900;
      margin-bottom: 20px;
      margin-top: 0;
      letter-spacing: 1.2px;
      text-align: center;
      font-family: 'Pretendard', Arial, sans-serif;
      text-shadow: 
        0 0 10px rgba(61, 255, 184, 0.4),
        0 2px 4px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1;
    }
    .description {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.85);
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      font-weight: 500;
      white-space: pre-wrap;
      margin: 0;
      min-height: 60px;
      line-height: 1.75;
      letter-spacing: 0.6px;
      font-family: 'Pretendard', Arial, sans-serif;
      position: relative;
      z-index: 1;
      backdrop-filter: blur(10px);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    /* === 추가: 상단 경고 리본 === */
    .alert-ribbon {
      margin: -6px 0 10px 0;
      padding: 10px 14px;
      border-radius: 12px;
      background: linear-gradient(135deg, #FFD76A 0%, #FFB84D 100%);
      color: #111;
      font-weight: 800;
      font-size: 16px;
      letter-spacing: 0.2px;
      text-align: center;
      box-shadow: 0 6px 16px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.45);
      border: 1px solid rgba(0,0,0,0.15);
      position: relative;
      z-index: 2;
    }
    .alert-ribbon .icon {
      font-size: 18px;
      margin-right: 8px;
      vertical-align: -1px;
    }
    .render-target.capture-polish .alert-ribbon {
      border-color: rgba(0,0,0,0.25) !important;
      background: linear-gradient(135deg, #FFC94A 0%, #FFA63B 100%) !important;
      box-shadow: 0 10px 22px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.55) !important;
    }

    /* === 가격표 컨테이너 === */
    #priceContainer {
      position: relative;
    }
  </style>
  <!-- 순서 매우 중요!! -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>

  <div class="render-target" id="capture">
    <!-- 상단 경고 리본 -->
    <div class="alert-ribbon" role="note" aria-label="사칭주의">
      <span class="icon">⚠️</span>
      사칭주의! ➡️ 디아블로4⚫더블랙 시즌10⚫ ⬅️만 공식 단톡방입니다<br>사칭목록 : 방장 '-'
    </div>

    <div>
      <h1 class="shop-title">
        <span class="icon">🦇</span> THE BLACK SHOP <span class="icon">🧛‍♂️</span>
      </h1>
      <div class="shop-subtitle">디아블로4 시즌10 버스 · 대리 · 아이템 전문 거래소</div>
      <hr class="subtitle-divider" />
    </div>

    <ul class="info-list">
      <li><span class="icon">🦾</span>모든 장비, 아이템, 재료 완비</li>
      <li><span class="icon">🚌</span>버스, 대리, 세팅 풀 지원</li>
      <li><span class="icon">🦸‍♂️</span>경험 많은 전문 기사 상시 대기</li>
      <li><span class="icon">🔥</span>합리적인 실시간 최저가 보장</li>
    </ul>
    <div class="cta-btn">
      💬 오픈채팅은 가격표 클릭!
    </div>
    <div class="alert-ribbon" role="note" aria-label="사칭주의">
      <span class="icon">⚠️</span>
      사칭주의! ➡️ 디아블로4⚫더블랙 시즌10⚫ ⬅️만 공식 단톡방입니다<br>사칭목록 : 방장 '-'
    </div>
    <hr class="divider" />
    <div>
      <h2 class="section-price-title">💰 실시간 가격표</h2>
    </div>

    <!-- 가격표 영역 (자동으로 경고 삽입됨) -->
    <div id="priceContainer"></div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // 파라미터 읽기
      const params = new URLSearchParams(window.location.search);
      const userId = params.get("uid");
      const mainTextParam = params.get("mainText");
      let mainTextLoaded = false;

      // 가격표에 자동으로 경고 삽입하는 함수
      function renderPriceWithWarnings(text) {
        const container = document.getElementById('priceContainer');
        container.innerHTML = ''; // 초기화

        // 임시 div로 텍스트 높이 측정
        const tempDiv = document.createElement('div');
        tempDiv.className = 'description';
        tempDiv.style.visibility = 'hidden';
        tempDiv.style.position = 'absolute';
        tempDiv.innerText = text;
        document.body.appendChild(tempDiv);

        const lines = text.split('\n');
        let currentText = '';
        let currentHeight = 0;
        const maxHeight = 3000; // 800px마다 경고 삽입

        lines.forEach((line, index) => {
          currentText += (index > 0 ? '\n' : '') + line;
          tempDiv.innerText = currentText;
          const newHeight = tempDiv.offsetHeight;

          // 800px 초과하면 경고 삽입
          if (newHeight > maxHeight && currentText.trim()) {
            // 현재까지의 텍스트를 description으로 추가
            const descDiv = document.createElement('div');
            descDiv.className = 'description';
            descDiv.innerText = currentText.substring(0, currentText.lastIndexOf('\n'));
            container.appendChild(descDiv);

            // 경고 리본 추가
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert-ribbon';
            alertDiv.setAttribute('role', 'note');
            alertDiv.setAttribute('aria-label', '사칭주의');
            alertDiv.innerHTML = `
              <span class="icon">⚠️</span>
              사칭주의! ➡️ 디아블로4⚫더블랙 시즌10⚫ ⬅️만 공식 단톡방입니다<br>사칭목록 : 방장 '-'
            `;
            container.appendChild(alertDiv);

            // 현재 라인부터 다시 시작
            currentText = line;
            tempDiv.innerText = currentText;
            currentHeight = tempDiv.offsetHeight;
          }
        });

        // 남은 텍스트 추가
        if (currentText.trim()) {
          const descDiv = document.createElement('div');
          descDiv.className = 'description';
          descDiv.innerText = currentText;
          container.appendChild(descDiv);
        }

        // 임시 div 제거
        document.body.removeChild(tempDiv);
      }

      // mainText 파라미터 있으면 바로 적용
      if (mainTextParam) {
        const decodedText = decodeURIComponent(mainTextParam);
        renderPriceWithWarnings(decodedText);
        mainTextLoaded = true;
      } else if (userId) {
        // Supabase 초기화
        const supabaseUrl = 'https://ssnmitgehgzzcpmqwhzt.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzbm1pdGdlaGd6emNwbXF3aHp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNjI1MDgsImV4cCI6MjA2ODkzODUwOH0.u3FrSDh5qYeccQmn0PkOs4nfqIhXLSFHhpWj2JXhTrA';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        (async function loadText() {
          const { data, error } = await supabase
            .from('user_texts')
            .select('main_text')
            .eq('user_id', userId)
            .order('created_at', { ascending: false })
            .limit(1);

          if (!error && data.length > 0) {
            renderPriceWithWarnings(data[0].main_text);
          }
          mainTextLoaded = true;
        })();
      } else {
        mainTextLoaded = true;
      }

      // IFRAME 메시지(캡처 요청) 핸들러
      window.addEventListener('message', async (event) => {
        if (event.data?.type === 'IFRAME_READY') {
          // mainText 적용 완료까지 최대 2초 대기
          let waitCount = 0;
          while (!mainTextLoaded && waitCount < 100) {
            await new Promise(res => setTimeout(res, 20));
            waitCount++;
          }
          if (document.fonts && document.fonts.ready) {
            await document.fonts.ready;
          }
          captureAndSend();
        }
      });

      function captureAndSend() {
        const target = document.querySelector('.render-target');
        if (!target) {
          console.error('.render-target 요소를 찾을 수 없습니다.');
          return;
        }

        // 캡쳐용 스킨 적용
        target.classList.add('capture-polish');

        // 스타일 페인트 완료 이후 캡쳐
        requestAnimationFrame(() => {
          html2canvas(target, {
            useCORS: true,
            backgroundColor: null,
            scale: Math.max(2, window.devicePixelRatio)
          }).then((canvas) => {
            const imgData = canvas.toDataURL('image/png');
            parent.postMessage({ type: 'CAPTURE_DONE', dataUrl: imgData }, '*');
          }).finally(() => {
            target.classList.remove('capture-polish');
          });
        });
      }
    });
  </script>

</body>
</html>
